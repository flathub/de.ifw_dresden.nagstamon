app-id: de.ifw_dresden.nagstamon
runtime: org.kde.Platform
runtime-version: '6.6'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: com.riverbankcomputing.PyQt.BaseApp
base-version: "6.6"
command: nagstamon
rename-desktop-file: nagstamon.desktop
rename-icon: nagstamon
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --persist=.nagstamon
  - --talk-name=org.freedesktop.Notifications
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
cleanup-commands:
  - /app/cleanup-BaseApp.sh
modules:
  - name: krb5
    subdir: src
    config-opts: &krb5-config-opts
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-static
      - --disable-rpath
    cleanup: &krb5-cleanup
      - /bin
      - /share/et
      - /share/examples
      - /share/man
    sources:
      - type: archive
        url: https://github.com/krb5/krb5/archive/refs/tags/krb5-1.21.2-final.tar.gz
        sha256: 5827fa39ead0e7f7b8a158799eb5d50b194129e81b378892caedcafe50c5c195
      - type: shell
        dest: src
        commands:
          - autoreconf -si

  - pypi-dependencies.json
  - name: dbus-run-session
    buildsystem: autotools
    cleanup: ["*"]
    sources:
      - type: archive
        url: https://gitlab.freedesktop.org/dbus/dbus/-/archive/dbus-1.15.8/dbus-dbus-1.15.8.tar.gz
        sha256: 3ae23cd28b96beac175eab0798d65c8e21e9fcf57132d840c170aaa7b21cd818
        x-checker-data:
          type: anitya
          project-id: 5356
          url-template: https://gitlab.freedesktop.org/dbus/dbus/-/archive/dbus-$version/dbus-dbus-$version.tar.gz
  - name: dbus-python
    buildsystem: autotools
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.3.2.tar.gz
        sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8
        x-checker-data:
          type: anitya
          project-id: 402
          url-template: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-$version.tar.gz
  - name: python3-cryptography
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-cryptography/cargo
        CARGO_NET_OFFLINE: "true"
        RUST_BACKTRACE: "1"
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation
    sources:
      - cargo-sources.json
      - type: file
        url: https://files.pythonhosted.org/packages/68/ce/95b0bae7968c65473e1298efb042e10cafc7bafc14d9e4f154008241c91d/cffi-1.16.0.tar.gz
        sha256: bcb3ef43e58665bbda2fb198698fcae6776483e0c4a631aa5647806c25e02cc0
      - type: file
        url: https://files.pythonhosted.org/packages/13/9e/a55763a32d340d7b06d045753c186b690e7d88780cafce5f88cb931536be/cryptography-42.0.5.tar.gz
        sha256: 6fe07eec95dfd477eb9530aef5bead34fec819b3aaf6c5bd6d20565da607bfe1
        x-checker-data:
          type: pypi
          name: cryptography

  - name: setup
    buildsystem: simple
    build-commands:
      - python3 setup.py bdist --format tar
      - tar -xvf dist/nagstamon*.tar --strip 2 -C /app
      - install -D nagstamon.sh /app/bin/nagstamon
      - mkdir -p /app/share/icons/hicolor/scalable/apps/
      - sed -i 's/416\.04276/412\.2182/g' /app/share/pixmaps/nagstamon.svg
      - install -Dm644 /app/share/pixmaps/nagstamon.svg /app/share/icons/hicolor/scalable/apps/
      - install -Dm644 de.ifw_dresden.nagstamon.appdata.xml -t /app/share/metainfo
    sources:
      - type: archive
        url: https://github.com/HenriWahl/Nagstamon/archive/refs/tags/v3.14.0.tar.gz
        sha256: f51c50feb7efa328d252c638b6602405d550a99622dd7e8f07341814879e9f30
      - type: file
        path: de.ifw_dresden.nagstamon.appdata.xml
      - type: file
        path: nagstamon.sh
